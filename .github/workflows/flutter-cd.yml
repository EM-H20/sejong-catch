name: ðŸš€ Flutter CD - í”„ë¡œë•ì…˜ ë°°í¬

# ðŸŽ¯ íŠ¸ë¦¬ê±° ì¡°ê±´: main ë¸Œëžœì¹˜ push ì‹œì—ë§Œ ë°°í¬ ì‹¤í–‰
on:
  push:
    branches: [main]
    paths:
      - 'sejong_catch-frontend/**'
      - '.github/workflows/flutter-cd.yml'
  # ìˆ˜ë™ íŠ¸ë¦¬ê±°ë„ ê°€ëŠ¥ (ì‘ê¸‰ ìƒí™©ìš©!)
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# ðŸ”§ í™˜ê²½ ë³€ìˆ˜
env:
  FLUTTER_VERSION: '3.24.0'
  WORKING_DIRECTORY: ./sejong_catch-frontend
  JAVA_VERSION: '17'

jobs:
  # ðŸ ì‚¬ì „ ê²€ì¦ (í•œë²ˆ ë” ì²´í¬!)
  pre_flight_check:
    name: ðŸ›¡ï¸ ë°°í¬ ì‚¬ì „ ê²€ì¦
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: âš¡ Flutter í™˜ê²½ ì„¤ì •
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: flutter pub get
        
      - name: ðŸ” ì½”ë“œ ë¶„ì„ (ë§ˆì§€ë§‰ ì ê²€!)
        run: |
          echo "ðŸ” ìµœì¢… ì½”ë“œ ë¶„ì„ì„ ì‹œìž‘í•©ë‹ˆë‹¤..."
          flutter analyze
          if [ $? -eq 0 ]; then
            echo "âœ… ì½”ë“œê°€ ì™„ë²½í•©ë‹ˆë‹¤! ë°°í¬ ì¤€ë¹„ ì™„ë£Œ! ðŸš€"
          else
            echo "âŒ ì½”ë“œì— ë¬¸ì œê°€ ìžˆì–´ìš”! ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤! ðŸš¨"
            exit 1
          fi
          
      - name: ðŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë§ˆì§€ë§‰ ê²€ì¦!)
        run: |
          echo "ðŸ§ª ìµœì¢… í…ŒìŠ¤íŠ¸ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
          flutter test
          if [ $? -eq 0 ]; then
            echo "ðŸŽ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼! ë°°í¬í•´ë„ ì¢‹ì•„ìš”! âœ…"
          else
            echo "ðŸ’¥ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ë°°í¬ ì·¨ì†Œ! ðŸ›‘"
            exit 1
          fi

  # ðŸ¤– Android ë¦´ë¦¬ì¦ˆ ë¹Œë“œ
  build_android:
    name: ðŸ¤– Android ë¦´ë¦¬ì¦ˆ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: pre_flight_check
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: â˜• Java í™˜ê²½ ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          
      - name: âš¡ Flutter í™˜ê²½ ì„¤ì •
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: flutter pub get
        
      # ðŸ” Android ì„œëª… ì„¤ì • (Secrets ì‚¬ìš©)
      - name: ðŸ” Android í‚¤ìŠ¤í† ì–´ ì„¤ì •
        if: ${{ github.event.inputs.deploy_environment != 'staging' }}
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "ðŸ” í‚¤ìŠ¤í† ì–´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤..."
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks
            echo "âœ… í‚¤ìŠ¤í† ì–´ ì„¤ì • ì™„ë£Œ!"
          else
            echo "âš ï¸  í‚¤ìŠ¤í† ì–´ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Debug ë¹Œë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤."
          fi
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          
      - name: ðŸ—ï¸ Android APK ë¹Œë“œ
        run: |
          echo "ðŸ¤– Android ë¦´ë¦¬ì¦ˆ ë¹Œë“œë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "ðŸ”’ ì„œëª…ëœ ë¦´ë¦¬ì¦ˆ APKë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤..."
            flutter build apk --release
          else
            echo "ðŸ”“ Debug APKë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤..."
            flutter build apk --debug
          fi
          echo "âœ… Android ë¹Œë“œ ì™„ë£Œ!"
          
      - name: ðŸ—ï¸ Android AAB ë¹Œë“œ (Play Storeìš©)
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "ðŸ“¦ Android App Bundleì„ ë¹Œë“œí•©ë‹ˆë‹¤..."
          flutter build appbundle --release
          echo "âœ… AAB ë¹Œë“œ ì™„ë£Œ!"
          
      - name: ðŸ“Š Android ë¹Œë“œ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: android-release-${{ github.sha }}
          path: |
            ${{ env.WORKING_DIRECTORY }}/build/app/outputs/flutter-apk/*.apk
            ${{ env.WORKING_DIRECTORY }}/build/app/outputs/bundle/release/*.aab
          retention-days: 30

  # ðŸŒ Web ë¦´ë¦¬ì¦ˆ ë¹Œë“œ
  build_web:
    name: ðŸŒ Web ë¦´ë¦¬ì¦ˆ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: pre_flight_check
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: âš¡ Flutter í™˜ê²½ ì„¤ì •
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: flutter pub get
        
      - name: ðŸŒ Web ë¦´ë¦¬ì¦ˆ ë¹Œë“œ
        run: |
          echo "ðŸŒ ì›¹ ë¦´ë¦¬ì¦ˆ ë¹Œë“œë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
          flutter build web --release --web-renderer canvaskit
          echo "âœ… Web ë¹Œë“œ ì™„ë£Œ! ë¸Œë¼ìš°ì €ì—ì„œ ë§Œë‚˜ìš”! ðŸ’»"
          
      - name: ðŸ“Š Web ë¹Œë“œ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: web-release-${{ github.sha }}
          path: ${{ env.WORKING_DIRECTORY }}/build/web/
          retention-days: 30
          
      # ðŸš€ GitHub Pages ë°°í¬ (ì„ íƒì )
      - name: ðŸš€ GitHub Pages ë°°í¬
        if: ${{ github.event.inputs.deploy_environment != 'staging' }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.WORKING_DIRECTORY }}/build/web
          cname: sejong-catch.dev  # ì»¤ìŠ¤í…€ ë„ë©”ì¸ (ì„ íƒì )

  # ðŸ“¦ GitHub Release ìƒì„±
  create_release:
    name: ðŸ“¦ GitHub Release ìƒì„±
    runs-on: ubuntu-latest
    needs: [build_android, build_web]
    if: ${{ github.event.inputs.deploy_environment != 'staging' }}
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ðŸ“¥ Android ë¹Œë“œ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: android-release-${{ github.sha }}
          path: ./android-release/
          
      - name: ðŸ“¥ Web ë¹Œë“œ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: web-release-${{ github.sha }}
          path: ./web-release/
          
      - name: ðŸ“ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        id: release_notes
        run: |
          VERSION="v$(date +'%Y.%m.%d')-${{ github.run_number }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          cat > release_notes.md << 'EOF'
          ## ðŸŽ‰ ì„¸ì¢… ìºì¹˜ ìƒˆ ë²„ì „ ì¶œì‹œ!
          
          ### ðŸš€ ì£¼ìš” ë³€ê²½ì‚¬í•­
          - Flutter ${{ env.FLUTTER_VERSION }} ê¸°ë°˜ ìµœì‹  ë¹Œë“œ
          - í¬ë¦¼ìŠ¨ ë ˆë“œ í…Œë§ˆ ì ìš©
          - ì„±ëŠ¥ ìµœì í™” ë° ë²„ê·¸ ìˆ˜ì •
          
          ### ðŸ“± ë‹¤ìš´ë¡œë“œ
          - **Android**: APK íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì„¤ì¹˜
          - **Web**: GitHub Pagesì—ì„œ ë°”ë¡œ ì‚¬ìš©
          
          ### ðŸ”§ ê¸°ìˆ  ì •ë³´
          - Build SHA: ${{ github.sha }}
          - Build Date: $(date +'%Y-%m-%d %H:%M:%S KST')
          - Environment: Production
          
          ---
          ðŸ— **ë°°í¬ ì™„ë£Œ!** ì´ì œ ì¹˜í‚¨ ì‹œì¼œë„ ë  ê²ƒ ê°™ë„¤ìš”!
          EOF
          
      - name: ðŸ·ï¸ GitHub Release ìƒì„±
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_notes.outputs.VERSION }}
          name: "ðŸš€ ì„¸ì¢… ìºì¹˜ ${{ steps.release_notes.outputs.VERSION }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            ./android-release/**/*.apk
            ./android-release/**/*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ðŸŽŠ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  deployment_success:
    name: ðŸŽ‰ ë°°í¬ ì™„ë£Œ!
    runs-on: ubuntu-latest
    needs: [build_android, build_web, create_release]
    if: always()
    
    steps:
      - name: ðŸŽŠ ì„±ê³µ ì¶•í•˜ ë©”ì‹œì§€
        if: ${{ needs.build_android.result == 'success' && needs.build_web.result == 'success' }}
        run: |
          echo "ðŸŽ‰ðŸŽ‰ðŸŽ‰ ì„¸ì¢… ìºì¹˜ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£ŒëìŠµë‹ˆë‹¤! ðŸŽ‰ðŸŽ‰ðŸŽ‰"
          echo "ðŸ“± Android APK: ë¦´ë¦¬ì¦ˆì—ì„œ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥"
          echo "ðŸŒ Web: GitHub Pagesì—ì„œ ì ‘ì† ê°€ëŠ¥"
          echo "ðŸ— ë°°í¬ ì¶•í•˜ ì¹˜í‚¨ íƒ€ìž„! ê³ ìƒí•˜ì…¨ì–´ìš”!"
          echo "ðŸŽ¯ ë²„ì „: ${{ github.sha }}"
          
      - name: ðŸš¨ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: ${{ needs.build_android.result == 'failure' || needs.build_web.result == 'failure' }}
        run: |
          echo "ðŸ’¥ðŸ’¥ðŸ’¥ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤! ðŸ’¥ðŸ’¥ðŸ’¥"
          echo "ðŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”!"
          echo "â˜• ë””ë²„ê¹… íƒ€ìž„... í™”ì´íŒ…!"
          exit 1